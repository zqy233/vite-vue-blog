

# XLSX

## SheetJS

SheetJS社区版提供了经受过考验的开源解决方案，可以从几乎任何复杂的电子表格中提取有用的数据，并生成新的电子表格，这些表格将与传统和现代软件一起使用

SheetJS Pro提供了数据处理之外的解决方案：轻松编辑复杂模板；通过造型展现你内心的毕加索；制作带有图像/图表/数据透视表的自定义表格；评估公式表达式和web应用程序的端口计算；自动化常见的电子表格任务等等

## 入门

### 下载

#### 独立的浏览器脚本

完整且独立的浏览器脚本，保存在dist/xlsx.full.min.js中，可以直接用script标签添加到页面

```js
<script lang="javascript" src="dist/xlsx.full.min.js"></script>
```

#### 可用的cdn

| CDN        | URL                                   |
| ---------- | ------------------------------------- |
| `unpkg`    | https://unpkg.com/xlsx/               |
| `jsDelivr` | https://jsdelivr.com/package/npm/xlsx |
| `CDNjs`    | https://cdnjs.com/libraries/xlsx      |

如下示例，通过unpkg使用最新版的xlsx

```js
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
```

#### 浏览器构建

完整的单文件版本为dist/xlsx.full.min.js
dist/xlsx.core.min.js省略了代码页库（不支持XLS编码）
一个更纤细的版本保存在dist/xlsx.mini.min.js，与完整版本相比：

- 省略了代码页库（不支持XLS编码）
- 不支持XLSB/XLS/Lotus 1-2-3/SpreadsheetML 2003/Numbers
- 删除了node流工具

使用[bower](https://bower.io/search/?q=js-xlsx):

```sh
$ bower install js-xlsx
```

#### ECMAScript 模块

ECMAScript模块版本名为xlsx.mjs，可以使用type=module来直接添加到包含\<script>标签的页面：

```js
<script type="module">
import { read, writeFileXLSX } from "./xlsx.mjs";

/* 加载代码页支持库以扩展对旧格式的支持 */
import { set_cptable } from "./xlsx.mjs";
import * as cptable from './dist/cpexcel.full.mjs';
set_cptable(cptable);
</script>
```

xlsx的npm包也提供了这些函数，可以用在Angular和其他框架中

```js
import { read, writeFileXLSX } from "xlsx";

/* 加载代码页支持库以扩展对旧格式的支持  */
import { set_cptable } from "xlsx";
import * as cptable from 'xlsx/dist/cpexcel.full.mjs';
set_cptable(cptable);
```

#### Deno

xlsx.mjs能被Deno导入，可以使用unpkg

```js
// @deno-types="https://unpkg.com/xlsx/types/index.d.ts"
import * as XLSX from 'https://unpkg.com/xlsx/xlsx.mjs';

/* load the codepage support library for extended support with older formats  */
import * as cptable from 'https://unpkg.com/xlsx/dist/cpexcel.full.mjs';
XLSX.set_cptable(cptable);
```

#### NodeJS

使用npm

```sh
$ npm install xlsx
```

默认情况下，支持require：

```js
var XLSX = require("xlsx");
```

还可以用xlsx.mjs来使用import

```js
import * as XLSX from 'xlsx/xlsx.mjs';

/* load 'fs' for readFile and writeFile support */
import * as fs from 'fs';
XLSX.set_fs(fs);

/* load 'stream' for stream support */
import { Readable } from 'stream';
XLSX.stream.set_readable(Readable);

/* load the codepage support library for extended support with older formats  */
import * as cpexcel from 'xlsx/dist/cpexcel.full.mjs';
XLSX.set_cptable(cpexcel);
```

#### Photoshop与InDesign

dist/xlsx.extendscript.js是一个用于Photoshop和InDesign的ExtendScript构建，包含在npm包中。它可以直接引用一个#include指令：

```sh
#include "xlsx.extendscript.js"
```

#### Internet Explorer和ECMAScript 3的兼容性

为了与JavaScript引擎广泛兼容，该库使用ECMAScript 3语言方言以及一些ES5功能（如Array#forEach）编写。较旧的浏览器需要垫片来提供缺失的功能

要使用垫片，请在加载xlsx.js的script标签之前添加垫片

```html
<!-- add the shim first -->
<script type="text/javascript" src="shim.min.js"></script>
<!-- after the shim is referenced, add the library -->
<script type="text/javascript" src="xlsx.full.min.js"></script>
```

该脚本还包括IE_LoadFile和IE_SaveFile，用于在Internet Explorer版本6-9中加载和保存文件。xlsx.extendscript.js打包垫片来适用于Photoshop和其他Adobe产品的格式

## 用法

大多数涉及电子表格和数据的场景可分为5个部分：

- `获取数据`：数据可以存储在任何地方：本地或远程文件、数据库、HTML表，甚至在web浏览器中以编程方式生成
- `提取数据`：对于电子表格文件，这涉及到解析原始字节以读取单元格数据。对于一般的JS数据，这涉及重塑数据
- `处理数据`：从生成汇总统计数据到清理数据记录，这一步是问题的核心
- `打包数据`：这可能涉及制作新的电子表格或使用JSON序列化。为UI工具字符串化或编写XML或简单地扁平化数据
- `发布数据`：电子表格文件可以上传到服务器或在本地写入。数据可以在HTML表格或数据网格中呈现给用户

一个常见情景，把存储在HTML表中的数据生成有效的电子表格导出。在下方示例中，页面上的一个HTML表将被删除，底部将添加一行，其中包含报告的日期，生成一个新文件并在本地下载。XLSX.writeFile负责打包数据并尝试本地下载：

```js
// Acquire Data (reference to the HTML table)
var table_elt = document.getElementById("my-table-id");

// Extract Data (create a workbook object from the table)
var workbook = XLSX.utils.table_to_book(table_elt);

// Process Data (add a new row)
var ws = workbook.Sheets["Sheet1"];
XLSX.utils.sheet_add_aoa(ws, [["Created "+new Date().toISOString()]], {origin:-1});

// Package and Release Data (`writeFile` tries to write and save an XLSB file)
XLSX.writeFile(workbook, "Report.xlsb");
```

该库尝试使用函数来简化步骤2和4，从电子表格文件（读/读文件）中提取有用的数据，并从数据（写/写文件）中生成新的电子表格文件。其他实用程序函数（如table_to_book）与其他常见数据源（如HTML表格）配合使用

本文档和各种演示项目涵盖了步骤1和5的一些常见场景和方法

实用功能有助于完成第3步

- 下方`获取和提取数据`指南描述了常见数据导入场景的解决方案
- 下方`打包和发布数据`指南描述了常见数据导出场景的解决方案
- 下方`处理数据`描述了指南常见工作簿处理和操作场景的解决方案
- 下方`实用函数`详细介绍了将JSON数组和其他常见JS结构转换为工作表对象的实用函数

## Sheetjs的理念

数据处理应该适合任何工作流

本库不强制推行单独的生命周期。它非常适合使用任何框架构建的网站和应用程序。简单的JS数据对象将很好地配合Web开发者和未来的浏览器API

JavaScript是一种强大的数据处理语言

“通用电子表格格式”是工作簿核心概念的简单对象表示。库中的各种函数提供了处理对象的低级工具

为了友好的JS处理，有一些实用函数用于将工作表的部分转换为数组或从数组中转换。以下示例将功能强大的JS数组方法与网络请求库相结合，以下载数据、选择所需信息并创建工作簿文件：

### 从JSON端点获取数据并生成工作簿

目标是生成一个包含美国总统姓名和生日的XLSB工作簿

#### 获取数据

原始数据

https://theunitedstates.io/congress-legislators/executive.json具有所需的数据。例如，约翰·亚当斯：

```json
John Adams{
  "id": { /* (data omitted) */ },
  "name": {
    "first": "John",          // <-- first name
    "last": "Adams"           // <-- last name
  },
  "bio": {
    "birthday": "1735-10-19", // <-- birthday
    "gender": "M"
  },
  "terms": [
    { "type": "viceprez", /* (other fields omitted) */ },
    { "type": "viceprez", /* (other fields omitted) */ },
    { "type": "prez", /* (other fields omitted) */ } // <-- look for "prez"
  ]
}
```

### 筛选总统

数据集包括亚伦·伯尔，一位从未当过总统的副总统！
c过滤创建一个新数组。一位总统至少任期一届，字段名为“prez”。为了测试是否至少有一个“prez”项，使用Array的some方法。完整的过滤器函数：

```js
const prez = raw_data.filter(row => row.terms.some(term => term.type === "prez"));
```

### 整理数据

在本例中，姓名是名与姓（row.name.first+“”+row.name.last）的组合，生日字段row.bio.birthday。使用Array的map方法，可以在一次调用中对数据集进行修饰：

```js
const rows = prez.map(row => ({
  name: row.name.first + " " + row.name.last,
  birthday: row.bio.birthday
}));
```

结果是一个没有嵌套的“简单”对象数组：

```js
[
  { name: "George Washington", birthday: "1732-02-22" },
  { name: "John Adams", birthday: "1735-10-19" },
  // ... one row per President
]
```

## 获取和提取数据

### 解析工作簿

### API

从电子表格字节中提取数据

```js
var workbook = XLSX.read(data, opts);
```

read方法可以从存储在JS字符串、“二进制字符串”、NodeJS缓冲区或类型化数组（Uint8Array或ArrayBuffer）中的电子表格字节中提取数据

从本地文件读取电子表格字节并提取数据

```js
var workbook = XLSX.readFile(filename, opts);
```

readFile方法尝试在提供的路径上读取电子表格文件。浏览器通常不允许以这种方式读取文件（这被认为是一种安全风险），尝试以这种方式读取文件会引发错误

第二个opts参数是可选的。“解析选项”涵盖了支持的属性和行为

## 解析选项

The exported `read` and `readFile` functions accept an options argument:

| Option Name   | Default | Description                                          |
| ------------- | ------- | ---------------------------------------------------- |
| `type`        |         | Input data encoding (see Input Type below)           |
| `raw`         | false   | If true, plain text parsing will not parse values ** |
| `codepage`    |         | If specified, use code page when appropriate **      |
| `cellFormula` | true    | Save formulae to the .f field                        |
| `cellHTML`    | true    | Parse rich text and save HTML to the `.h` field      |
| `cellNF`      | false   | Save number format string to the `.z` field          |
| `cellStyles`  | false   | Save style/theme info to the `.s` field              |
| `cellText`    | true    | Generated formatted text to the `.w` field           |
| `cellDates`   | false   | Store dates as type `d` (default is `n`)             |
| `dateNF`      |         | If specified, use the string for date code 14 **     |
| `sheetStubs`  | false   | Create cell objects of type `z` for stub cells       |
| `sheetRows`   | 0       | If >0, read the first `sheetRows` rows **            |
| `bookDeps`    | false   | If true, parse calculation chains                    |
| `bookFiles`   | false   | If true, add raw files to book object **             |
| `bookProps`   | false   | If true, only parse enough to get book metadata **   |
| `bookSheets`  | false   | If true, only parse enough to get the sheet names    |
| `bookVBA`     | false   | If true, copy VBA blob to `vbaraw` field **          |
| `password`    | ""      | If defined and file is encrypted, use password **    |
| `WTF`         | false   | If true, throw errors on unexpected file features ** |
| `sheets`      |         | If specified, only parse specified sheets **         |
| `PRN`         | false   | If true, allow parsing of PRN files **               |
| `xlfn`        | false   | If true, preserve `_xlfn.` prefixes in formulae **   |
| `FS`          |         | DSV Field Separator override                         |

## 许可

有关详细信息，请参阅随附的许可证文件。原始作者保留Apache 2.0许可证未明确授予的所有权利

## 参考

OSP-covered Specifications

- `MS-CFB`: Compound File Binary File Format
- `MS-CTXLS`: Excel Custom Toolbar Binary File Format
- `MS-EXSPXML3`: Excel Calculation Version 2 Web Service XML Schema
- `MS-ODATA`: Open Data Protocol (OData)
- `MS-ODRAW`: Office Drawing Binary File Format
- `MS-ODRAWXML`: Office Drawing Extensions to Office Open XML Structure
- `MS-OE376`: Office Implementation Information for ECMA-376 Standards Support
- `MS-OFFCRYPTO`: Office Document Cryptography Structure
- `MS-OI29500`: Office Implementation Information for ISO/IEC 29500 Standards Support
- `MS-OLEDS`: Object Linking and Embedding (OLE) Data Structures
- `MS-OLEPS`: Object Linking and Embedding (OLE) Property Set Data Structures
- `MS-OODF3`: Office Implementation Information for ODF 1.2 Standards Support
- `MS-OSHARED`: Office Common Data Types and Objects Structures
- `MS-OVBA`: Office VBA File Format Structure
- `MS-XLDM`: Spreadsheet Data Model File Format
- `MS-XLS`: Excel Binary File Format (.xls) Structure Specification
- `MS-XLSB`: Excel (.xlsb) Binary File Format
- `MS-XLSX`: Excel (.xlsx) Extensions to the Office Open XML SpreadsheetML File Format
- `XLS`: Microsoft Office Excel 97-2007 Binary File Format Specification
- `RTF`: Rich Text Format
- `MS-CFB`: Compound File Binary File Format
- `MS-CTXLS`: Excel Custom Toolbar Binary File Format
- `MS-EXSPXML3`: Excel Calculation Version 2 Web Service XML Schema
- `MS-ODATA`: Open Data Protocol (OData)
- `MS-ODRAW`: Office Drawing Binary File Format
- `MS-ODRAWXML`: Office Drawing Extensions to Office Open XML Structure
- `MS-OE376`: Office Implementation Information for ECMA-376 Standards Support
- `MS-OFFCRYPTO`: Office Document Cryptography Structure
- `MS-OI29500`: Office Implementation Information for ISO/IEC 29500 Standards Support
- `MS-OLEDS`: Object Linking and Embedding (OLE) Data Structures
- `MS-OLEPS`: Object Linking and Embedding (OLE) Property Set Data Structures
- `MS-OODF3`: Office Implementation Information for ODF 1.2 Standards Support
- `MS-OSHARED`: Office Common Data Types and Objects Structures
- `MS-OVBA`: Office VBA File Format Structure
- `MS-XLDM`: Spreadsheet Data Model File Format
- `MS-XLS`: Excel Binary File Format (.xls) Structure Specification
- `MS-XLSB`: Excel (.xlsb) Binary File Format
- `MS-XLSX`: Excel (.xlsx) Extensions to the Office Open XML SpreadsheetML File Format
- `XLS`: Microsoft Office Excel 97-2007 Binary File Format Specification
- `RTF`: Rich Text Format

ISO/IEC 29500:2012(E) "Information technology — Document description and processing languages — Office Open XML File Formats"

Open Document Format for Office Applications Version 1.2 (29 September 2011)

Worksheet File Format (From Lotus) December 1984