# 长列表优化

业务开发中存在长列表显示需求，会出现几千条数据的情况，也就意味着要一次性渲染几千条数据，会造成明显的卡顿，这时就有必要对聊天列表进行性能优化来提升用户体验

对于这种需求，可能很多人首先想到的就是使用懒加载进行性能优化，但是对于很长的列表来说懒加载有三个致命的缺点：

1. 如果一直加载到底, 那么最终还是会出现大量的DOM节点，导致滚动不流畅
2. 想要定位到某一个位置的数据会非常困难
3. 滚动条无法正确反映操作者当前浏览的信息在全部列表中的位置。而且大量数据加载，一次给我加载十几条，滚到底太慢了

懒加载无法满足真正的长列表展示，那么如果真正要解决此类问题该怎么办？还有一种思路就是：列表局部渲染，又被称为虚拟滚动

## 虚拟滚动

```vue
<template>
  <div>
    <input type="text" v-model.number="dataLength" />条
    <div class="virtual-scroller" @scroll="onScroll" :style="{ height: 600 + 'px' }">
      <div class="phantom" :style="{ height: dataLength * itemHeight + 'px' }">
        <ul :style="{ 'margin-top': `${scrollTop}px` }">
          <li v-for="item in visibleList" :key="item.name" :style="{ height: `${itemHeight}px`, 'line-height': `${itemHeight}px` }">
            <div>
              <div>{{ item.name }}</div>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </div>
</template>

<script lang="ts" setup>
let itemHeight = ref(60)
let dataLength = ref(500000)
let startIndex = ref(0)
let endIndex = ref(10)
let scrollTop = ref(0)

const dataList = computed(() => {
  const newDataList = [...Array(dataLength.value || 0).keys()].map((v, i) => ({
    name: `第${i + 1}项`,
    height: itemHeight.value
  }))
  return newDataList
})

const visibleList = computed(() => {
  console.log(dataList.value)
  return dataList.value.slice(startIndex.value, endIndex.value)
})

function onScroll(e: any) {
  const s = e.target.scrollTop
  scrollTop.value = s
  startIndex.value = Math.floor(s / itemHeight.value)
  endIndex.value = startIndex.value + 10
}
</script>

<style scoped>
.virtual-scroller {
  height: 600px;
  overflow: auto;
}

.phantom {
  overflow: hidden;
}
</style>
```

