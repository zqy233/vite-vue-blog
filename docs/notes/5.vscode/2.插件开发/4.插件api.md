# 插件api

## [官方英文文档](https://code.visualstudio.com/api/references/vscode-api)

## languages

用于参与特定语言的编辑器功能，如智能感知、代码操作、诊断等

具体来说，就是参与自动单词补全、代码导航或代码检查等功能

languages api将所有UI和操作都准备就绪，只需要提供数据就能实现这类功能。例如，要创建一个悬停，只需提供一个函数，该函数可以通过文本文档和返回悬停信息的位置来调用。其余的工作，如跟踪鼠标、定位悬停、保持悬停稳定等，由vscode编辑器自行负责

```js
languages.registerHoverProvider('javascript', {
  provideHover(document, position, token) {
    return new Hover('I am a hover!');
  }
})
```

注册是使用一个文档选择器完成的，它要么是一个语言id，比如javascript，要么是一个更复杂的过滤器，比如{language:'typescript'，scheme:'file'}。将文档与这样的选择器进行匹配将得到一个分数，用于确定是否以及如何使用提供者。当分数相等时，最后一个provider获胜。对于允许完全算术的功能，如hover，分数仅检查为>0，对于其他功能，如IntelliSense，分数用于确定要求provider参与的顺序

## registerDocumentFormattingEditProvider

类型：(selector: DocumentSelector, provider: DocumentFormattingEditProvider): Disposable

说明：为文档格式化注册一个提供程序, 可以为一种语言注册多个提供程序，在这种情况下，提供程序按分数排序，并使用最匹配的提供程序。所选提供程序运行失败将导致整个操作失败

| 属性                                     | 描述                             |
| ---------------------------------------- | -------------------------------- |
| selector: DocumentSelector               | 定义此提供程序适用的文档的选择器 |
| provider: DocumentFormattingEditProvider | 文档格式编辑提供程序             |

| return     | 描述                             |
| ---------- | -------------------------------- |
| Disposable | 处置时注销此提供程序的一次性文件 |

## registerDocumentHighlightProvider

类型：(selector: DocumentSelector, provider: DocumentHighlightProvider): Disposable

说明：为文档高亮显示注册一个提供程序，可以为一种语言注册多个提供程序，在这种情况下，提供程序按分数排序，并按顺序要求分组以获取文档突出显示。当提供程序返回非错误或非失败结果时，该过程停止

| 属性                                | 描述                             |
| ----------------------------------- | -------------------------------- |
| selector: DocumentSelector          | 定义此提供程序适用的文档的选择器 |
| provider: DocumentHighlightProvider | 文档高亮提供程序                 |

| return     | 描述                             |
| ---------- | -------------------------------- |
| Disposable | 处置时注销此提供程序的一次性文件 |

## window

> vscode开发工具的窗口，提供一些显示消息、选择和请求用户输入的ui组件，和调用这些ui组件的方法

### activeTextEditor

> 当前激活也就是当前打开的编辑器

### showOpenDialog

类型：(options?: OpenDialogOptions): Thenable<Uri[] | undefined>

说明：向用户显示一个文件打开对话框，允许用户选择一个文件进行打开

| 属性                        | 描述             |
| --------------------------- | ---------------- |
| options?: OpenDialogOptions | 控制对话框的选项 |

| 返回           | 描述                             |
| -------------- | -------------------------------- |
| Thenable<Uri[] | 解析为所选资源或未定义资源的承诺 |

#### OpenDialogOptions

打开文件弹窗的配置选项

| 属性                       | 描述                                                         |
| -------------------------- | ------------------------------------------------------------ |
| canSelectFiles?: boolean   | 允许选择文件，默认为true                                     |
| canSelectFolders?: boolean | 允许选择文件夹，默认为false                                  |
| canSelectMany?: boolean    | 允许选择多个文件或文件夹                                     |
| defaultUri?: Uri           | 打开时默认选择的资源                                         |
| filters?:                  | 对话框使用的一组文件筛选器。每个条目都是一个人类可读的标签，比如“TypeScript”，以及一系列扩展名，例如"{'Images': ['png', 'jpg']     'TypeScript': ['ts', 'tsx'] }" |
| openLabel?: string         | 打开按钮的可读字符串                                         |
| title?: string             | 对话标题，此参数可能会被忽略，因为并非所有操作系统都在打开的对话框（例如macOS）上显示标题 |

### showInformationMessage

### showWarningMessage

### showErrorMessage

右下角消息弹窗

```ts
window.showInformationMessage("info!")
window.showWarningMessage("warning!")
window.showErrorMessage("error!")
```

### showInputBox

打开一个输入框，要求用户输入，如果输入框被取消（例如按ESC键），则返回值将为undefined。否则，返回的值将是用户键入的字符串，或者如果用户没有键入任何内容，而是用OK关闭了输入框，则返回的值将是空字符串。

## commands

### executeCommand

触发vscode命令

```ts
 // 触发鼠标光标向左移动的命令
 commands.executeCommand("cursorLeft")
```

## 自动补全通过

`vscode.languages.registerCompletionItemProvider`方法注册自动完成实现，接收3个参数：

- 第一个是要关联的文件类型；
- 第二个是一个对象，里面必须包含`provideCompletionItems`和`resolveCompletionItem`这2个方法；
- 第三个是一个可选的触发提示的字符列表；

这里我们实现这样一个例子，当输入`this.dependencies.xxx`时自动把`package.json`中的依赖全部带出来，包括`dependencies`、`devDependencies`，就像这样：

```ts
const vscode = require('vscode');
const util = require('./util');

/**
 * 自动提示实现，这里模拟一个很简单的操作
 * 当输入 this.dependencies.xxx时自动把package.json中的依赖带出来
 * 当然这个例子没啥实际意义，仅仅是为了演示如何实现功能
 * @param {*} document 
 * @param {*} position 
 * @param {*} token 
 * @param {*} context 
 */
function provideCompletionItems(document, position, token, context) {
    const line        = document.lineAt(position);
    const projectPath = util.getProjectPath(document);

    // 只截取到光标位置为止，防止一些特殊情况
    const lineText = line.text.substring(0, position.character);
    // 简单匹配，只要当前光标前的字符串为`this.dependencies.`都自动带出所有的依赖
    if(/(^|=| )\w+\.dependencies\.$/g.test(lineText)) {
        const json = require(`${projectPath}/package.json`);
        const dependencies = Object.keys(json.dependencies || {}).concat(Object.keys(json.devDependencies || {}));
        return dependencies.map(dep => {
            // vscode.CompletionItemKind 表示提示的类型
            return new vscode.CompletionItem(dep, vscode.CompletionItemKind.Field);
        })
    }
}

/**
 * 光标选中当前自动补全item时触发动作，一般情况下无需处理
 * @param {*} item 
 * @param {*} token 
 */
function resolveCompletionItem(item, token) {
    return null;
}

module.exports = function(context) {
    // 注册代码建议提示，只有当按下“.”时才触发
    context.subscriptions.push(vscode.languages.registerCompletionItemProvider('javascript', {
        provideCompletionItems,
        resolveCompletionItem
    }, '.'));
};
```

